<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="卸载管理器">
<meta name="theme-color" content="#4F46E5">
<link rel="manifest" href="manifest.json">
<title>卸载管理器</title>
<script src="https://unpkg.com/mqtt@5/dist/mqtt.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary:#4F46E5;--primary-light:#818CF8;--danger:#EF4444;--success:#22C55E;--warn:#F59E0B;--bg:#F3F4F6;--card:#FFF;--text:#111827;--text2:#6B7280;--radius:14px}
@media(prefers-color-scheme:dark){
:root{--bg:#111827;--card:#1F2937;--text:#F9FAFB;--text2:#9CA3AF}
}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;min-height:100dvh;padding-bottom:env(safe-area-inset-bottom)}
.header{background:var(--primary);color:#fff;padding:16px 20px;padding-top:calc(env(safe-area-inset-top) + 16px);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.header h1{font-size:18px;font-weight:600}
.header .status{display:flex;align-items:center;gap:6px;font-size:13px;opacity:.9}
.header .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.container{padding:16px;max-width:500px;margin:0 auto}
.card{background:var(--card);border-radius:var(--radius);padding:20px;margin-bottom:14px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.card-title{font-size:13px;color:var(--text2);font-weight:500;text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px}

/* Pairing View */
.pair-icon{font-size:64px;text-align:center;margin:40px 0 24px}
.pair-title{text-align:center;font-size:22px;font-weight:700;margin-bottom:8px}
.pair-sub{text-align:center;color:var(--text2);font-size:14px;margin-bottom:32px}
.code-input{display:flex;justify-content:center;gap:8px;margin-bottom:24px}
.code-input input{width:44px;height:56px;text-align:center;font-size:24px;font-weight:700;border:2px solid #E5E7EB;border-radius:12px;background:var(--card);color:var(--text);outline:none;transition:border .2s}
.code-input input:focus{border-color:var(--primary)}
@media(prefers-color-scheme:dark){.code-input input{border-color:#374151}}

.btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:opacity .2s,transform .1s}
.btn:active{transform:scale(.98)}
.btn-primary{background:var(--primary);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-outline{background:transparent;border:2px solid var(--danger);color:var(--danger)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-sm{padding:10px 16px;font-size:14px;width:auto;border-radius:10px}
.spinner{width:18px;height:18px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}

.error{color:var(--danger);font-size:13px;text-align:center;margin-top:12px}

/* Device View */
.device-card{display:flex;align-items:center;gap:14px}
.device-avatar{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
.device-info{flex:1;min-width:0}
.device-name{font-size:16px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.device-id{font-size:11px;color:var(--text2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.online-badge{font-size:12px;padding:3px 10px;border-radius:20px;font-weight:500;flex-shrink:0}
.online-badge.on{background:#DCFCE7;color:#16A34A}
.online-badge.off{background:#F3F4F6;color:#9CA3AF}
@media(prefers-color-scheme:dark){.online-badge.on{background:#14532D}.online-badge.off{background:#374151}}

.stats{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat-item{text-align:center;padding:14px 8px;border-radius:12px;background:var(--bg)}
.stat-val{font-size:24px;font-weight:700}
.stat-label{font-size:12px;color:var(--text2);margin-top:4px}

.nav-item{display:flex;align-items:center;padding:14px 0;cursor:pointer;-webkit-tap-highlight-color:transparent}
.nav-item .icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;margin-right:12px;flex-shrink:0}
.nav-item .label{flex:1;font-size:15px;font-weight:500}
.nav-item .arrow{color:var(--text2);font-size:13px}
.nav-item .count{color:var(--text2);font-size:14px;margin-right:8px}

.actions{display:flex;flex-direction:column;gap:10px}

/* App List */
.search-bar{position:sticky;top:54px;z-index:50;padding:12px 0;background:var(--bg)}
.search-bar input{width:100%;padding:10px 16px;border-radius:12px;border:1px solid #E5E7EB;font-size:15px;background:var(--card);color:var(--text);outline:none}
@media(prefers-color-scheme:dark){.search-bar input{border-color:#374151}}
.search-bar input:focus{border-color:var(--primary)}

.list-header{display:flex;align-items:center;justify-content:space-between;margin:8px 0}
.list-header .title{font-size:14px;font-weight:600}
.list-header .actions-row{display:flex;gap:12px}
.list-header .action-link{font-size:13px;color:var(--primary);cursor:pointer;font-weight:500}

.app-row{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid rgba(0,0,0,.05)}
@media(prefers-color-scheme:dark){.app-row{border-color:rgba(255,255,255,.06)}}
.app-row:last-child{border-bottom:none}
.app-info{flex:1;min-width:0;margin-right:8px}
.app-name{font-size:15px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.app-pkg{font-size:11px;color:var(--text2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.app-size{font-size:12px;color:var(--text2);flex-shrink:0;margin-right:12px}
.toggle{position:relative;width:48px;height:28px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{position:absolute;inset:0;background:#D1D5DB;border-radius:28px;cursor:pointer;transition:.2s}
.toggle .slider::before{content:'';position:absolute;width:22px;height:22px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.2s}
.toggle input:checked+.slider{background:var(--success)}
.toggle input:checked+.slider::before{transform:translateX(20px)}
.toggle input:disabled+.slider{opacity:.5;cursor:not-allowed}

.summary-bar{display:flex;justify-content:space-around;padding:12px;background:var(--card);border-radius:12px;margin-bottom:10px;font-size:13px;font-weight:500}
.summary-bar span{display:flex;align-items:center;gap:4px}

.back-btn{background:none;border:none;color:#fff;font-size:15px;cursor:pointer;padding:4px 8px;margin-left:-8px;display:flex;align-items:center;gap:4px}

/* Toast */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:10px 24px;border-radius:20px;font-size:14px;z-index:200;animation:fadeUp .3s}
@keyframes fadeUp{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

/* Modal */
.modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:150;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn .2s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--card);border-radius:20px 20px 0 0;padding:24px;padding-bottom:calc(24px + env(safe-area-inset-bottom));width:100%;max-width:500px;animation:slideUp .3s}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal h3{font-size:18px;font-weight:600;margin-bottom:8px}
.modal p{color:var(--text2);font-size:14px;margin-bottom:20px;line-height:1.5}
.modal .btn-group{display:flex;gap:10px}
.modal .btn-group .btn{flex:1}
.btn-cancel{background:var(--bg);color:var(--text)}
</style>
</head>
<body>
<div id="app"></div>
<script>
const BROKER = 'wss://broker-cn.emqx.io:8084/mqtt';
const TOPIC_PREFIX = 'uninstall';
const STORE_KEY_DEVICE_ID = 'um_device_id';
const STORE_KEY_DEVICE_NAME = 'um_device_name';

// Simple reactive state
const state = {
  view: 'loading',        // loading | pairing | device | applist
  connected: false,
  pairingCode: ['','','','','',''],
  isPairing: false,
  pairingError: '',
  deviceId: localStorage.getItem(STORE_KEY_DEVICE_ID) || '',
  deviceName: localStorage.getItem(STORE_KEY_DEVICE_NAME) || '',
  status: null,           // { online, battery, pendingUninstall }
  apps: [],
  searchText: '',
  toast: '',
  modal: null,            // { title, message, confirmText, onConfirm, danger }
};

let client = null;
let renderTimer = null;

function scheduleRender() {
  if (!renderTimer) renderTimer = requestAnimationFrame(() => { renderTimer = null; render(); });
}

// Proxy state for auto-rendering
const S = new Proxy(state, {
  set(t, k, v) { t[k] = v; scheduleRender(); return true; }
});

// MQTT
function mqttConnect() {
  const clientId = 'web_mgr_' + Math.random().toString(36).slice(2, 10);
  client = mqtt.connect(BROKER, {
    clientId,
    clean: true,
    keepalive: 30,
    connectTimeout: 10000,
    reconnectPeriod: 3000,
  });

  client.on('connect', () => {
    S.connected = true;
    if (S.deviceId) {
      client.subscribe(`${TOPIC_PREFIX}/${S.deviceId}/#`, { qos: 1 });
      sendCommand('refresh');
    }
  });

  client.on('close', () => { S.connected = false; });
  client.on('error', () => {});
  client.on('message', handleMessage);
}

function handleMessage(topic, payload) {
  const str = payload.toString();
  if (!str) return;
  let data;
  try { data = JSON.parse(str); } catch { return; }

  // Pairing response
  if (topic.startsWith(`${TOPIC_PREFIX}/pair/`) && topic.endsWith('/response')) {
    if (S.isPairing && data.deviceId) {
      const code = S.pairingCode.join('');
      // Confirm pairing to Android
      client.publish(`${TOPIC_PREFIX}/pair/${code}`, JSON.stringify({ manager: true }), { qos: 1 });
      // Unsubscribe pairing
      client.unsubscribe(`${TOPIC_PREFIX}/pair/${code}/response`);
      // Save
      S.deviceId = data.deviceId;
      S.deviceName = data.deviceName || 'Android Device';
      localStorage.setItem(STORE_KEY_DEVICE_ID, S.deviceId);
      localStorage.setItem(STORE_KEY_DEVICE_NAME, S.deviceName);
      S.isPairing = false;
      S.view = 'device';
      // Subscribe to device
      client.subscribe(`${TOPIC_PREFIX}/${S.deviceId}/#`, { qos: 1 });
      sendCommand('refresh');
      showToast('配对成功');
    }
    return;
  }

  // Status
  if (topic.endsWith('/status')) {
    S.status = data;
    scheduleRender();
    return;
  }

  // Apps
  if (topic.endsWith('/apps')) {
    if (data.apps) {
      S.apps = data.apps;
      scheduleRender();
    }
    return;
  }

  // Whitelist current
  if (topic.endsWith('/whitelist/current')) {
    if (data.packages) {
      S.apps = S.apps.map(a => ({
        ...a,
        isWhitelisted: a.isSystem || data.packages.includes(a.packageName)
      }));
      scheduleRender();
      showToast('白名单已同步');
    }
    return;
  }
}

function startPairing() {
  const code = S.pairingCode.join('');
  if (code.length !== 6 || !S.connected) return;
  S.isPairing = true;
  S.pairingError = '';
  client.subscribe(`${TOPIC_PREFIX}/pair/${code}/response`, { qos: 1 });
  // Timeout
  setTimeout(() => {
    if (S.isPairing) {
      S.isPairing = false;
      client.unsubscribe(`${TOPIC_PREFIX}/pair/${code}/response`);
      S.pairingError = '配对超时，请确认 Android 端已显示此配对码';
    }
  }, 15000);
}

function sendCommand(cmd) {
  if (!S.deviceId || !client) return;
  client.publish(`${TOPIC_PREFIX}/${S.deviceId}/command`, JSON.stringify({ command: cmd }), { qos: 1 });
}

function sendWhitelist() {
  if (!S.deviceId || !client) return;
  const packages = S.apps.filter(a => a.isWhitelisted).map(a => a.packageName);
  client.publish(`${TOPIC_PREFIX}/${S.deviceId}/whitelist/set`, JSON.stringify({ packages }), { qos: 1 });
  showToast('白名单已发送');
}

function unpair() {
  sendCommand('unpair');
  if (S.deviceId) client.unsubscribe(`${TOPIC_PREFIX}/${S.deviceId}/#`);
  S.deviceId = '';
  S.deviceName = '';
  S.status = null;
  S.apps = [];
  localStorage.removeItem(STORE_KEY_DEVICE_ID);
  localStorage.removeItem(STORE_KEY_DEVICE_NAME);
  S.view = 'pairing';
  showToast('已解除配对');
}

function showToast(msg) {
  S.toast = msg;
  setTimeout(() => { S.toast = ''; }, 2000);
}

function showModal(opts) { S.modal = opts; }
function closeModal() { S.modal = null; }

// Rendering
function h(tag, attrs, ...children) {
  const el = document.createElement(tag);
  if (attrs) {
    for (const [k, v] of Object.entries(attrs)) {
      if (k.startsWith('on') && typeof v === 'function') {
        el.addEventListener(k.slice(2).toLowerCase(), v);
      } else if (k === 'className') {
        el.className = v;
      } else if (k === 'checked') {
        el.checked = v;
      } else if (k === 'disabled') {
        if (v) el.disabled = true;
      } else if (k === 'type') {
        el.type = v;
      } else if (k === 'inputMode') {
        el.inputMode = v;
      } else if (k === 'maxLength') {
        el.maxLength = v;
      } else if (k === 'placeholder') {
        el.placeholder = v;
      } else if (k === 'value') {
        el.value = v;
      } else if (k === 'htmlFor') {
        el.htmlFor = v;
      } else if (k === 'style') {
        el.style.cssText = v;
      }
    }
  }
  for (const c of children.flat(Infinity)) {
    if (c == null || c === false) continue;
    el.appendChild(typeof c === 'string' || typeof c === 'number' ? document.createTextNode(c) : c);
  }
  return el;
}

function renderHeader(title, backFn) {
  return h('div', { className: 'header' },
    backFn
      ? h('button', { className: 'back-btn', onClick: backFn }, '\u2039 ', title)
      : h('h1', null, title),
    h('div', { className: 'status' },
      h('span', { className: 'dot', style: `background:${S.connected ? '#4ADE80' : '#F87171'}` }),
      S.connected ? 'MQTT 已连接' : '未连接'
    )
  );
}

function renderPairing() {
  const codeInputs = S.pairingCode.map((v, i) => {
    const inp = h('input', {
      type: 'text',
      inputMode: 'numeric',
      maxLength: 1,
      value: v,
      onInput: (e) => {
        const val = e.target.value.replace(/\D/g, '');
        S.pairingCode[i] = val;
        if (val && i < 5) {
          const next = e.target.parentElement.children[i + 1];
          if (next) next.focus();
        }
        scheduleRender();
      },
      onKeydown: (e) => {
        if (e.key === 'Backspace' && !e.target.value && i > 0) {
          const prev = e.target.parentElement.children[i - 1];
          if (prev) { prev.focus(); prev.select(); }
        }
      },
      onPaste: (e) => {
        e.preventDefault();
        const text = (e.clipboardData.getData('text') || '').replace(/\D/g, '').slice(0, 6);
        for (let j = 0; j < 6; j++) S.pairingCode[j] = text[j] || '';
        scheduleRender();
        // Focus last filled or first empty
        setTimeout(() => {
          const idx = Math.min(text.length, 5);
          const target = e.target.parentElement.children[idx];
          if (target) target.focus();
        }, 0);
      }
    });
    return inp;
  });

  const canPair = S.pairingCode.join('').length === 6 && S.connected && !S.isPairing;

  return h('div', null,
    renderHeader('卸载管理器'),
    h('div', { className: 'container' },
      h('div', { className: 'pair-icon' }, '\uD83D\uDD17'),
      h('div', { className: 'pair-title' }, '配对 Android 设备'),
      h('div', { className: 'pair-sub' }, '输入 Android 端显示的 6 位配对码'),
      h('div', { className: 'code-input' }, ...codeInputs),
      h('button', {
        className: 'btn btn-primary',
        disabled: !canPair,
        onClick: startPairing,
        style: 'max-width:280px;margin:0 auto'
      },
        S.isPairing ? h('span', { className: 'spinner' }) : null,
        S.isPairing ? '配对中...' : '开始配对'
      ),
      S.pairingError ? h('div', { className: 'error' }, S.pairingError) : null
    )
  );
}

function renderDevice() {
  const online = S.status?.online && S.connected;
  const battery = S.status?.battery ?? '--';
  const pending = S.status?.pendingUninstall ?? '--';

  return h('div', null,
    renderHeader('卸载管理器'),
    h('div', { className: 'container' },
      // Device card
      h('div', { className: 'card' },
        h('div', { className: 'device-card' },
          h('div', { className: 'device-avatar' }, '\uD83D\uDCF1'),
          h('div', { className: 'device-info' },
            h('div', { className: 'device-name' }, S.deviceName || 'Android 设备'),
            h('div', { className: 'device-id' }, S.deviceId)
          ),
          h('span', { className: `online-badge ${online ? 'on' : 'off'}` }, online ? '在线' : '离线')
        )
      ),

      // Stats
      h('div', { className: 'card' },
        h('div', { className: 'stats' },
          h('div', { className: 'stat-item' },
            h('div', { className: 'stat-val', style: battery !== '--' && battery <= 20 ? 'color:var(--danger)' : '' },
              battery !== '--' ? `${battery}%` : '--'),
            h('div', { className: 'stat-label' }, '\uD83D\uDD0B 电量')
          ),
          h('div', { className: 'stat-item' },
            h('div', { className: 'stat-val', style: pending !== '--' && pending > 0 ? 'color:var(--warn)' : 'color:var(--success)' },
              `${pending}`),
            h('div', { className: 'stat-label' }, '\uD83D\uDDD1\uFE0F 待卸载')
          )
        )
      ),

      // Navigation
      h('div', { className: 'card', style: 'padding:6px 20px' },
        h('div', { className: 'nav-item', onClick: () => { S.view = 'applist'; } },
          h('div', { className: 'icon', style: 'background:#EEF2FF;' }, '\uD83D\uDCCB'),
          h('span', { className: 'label' }, '应用列表'),
          h('span', { className: 'count' }, `${S.apps.length} 个`),
          h('span', { className: 'arrow' }, '\u203A')
        )
      ),

      // Actions
      h('div', { className: 'card' },
        h('div', { className: 'card-title' }, '操作'),
        h('div', { className: 'actions' },
          h('button', {
            className: 'btn btn-primary btn-sm',
            onClick: () => { sendCommand('refresh'); showToast('已发送刷新指令'); }
          }, '\uD83D\uDD04 刷新设备数据'),
          h('button', {
            className: 'btn btn-danger btn-sm',
            onClick: () => showModal({
              title: '确认一键卸载',
              message: '将卸载 Android 设备上所有非白名单应用，此操作不可撤销',
              confirmText: '卸载',
              danger: true,
              onConfirm: () => { sendCommand('uninstall'); closeModal(); showToast('已发送卸载指令'); }
            })
          }, '\uD83D\uDDD1\uFE0F 一键卸载'),
          h('button', {
            className: 'btn btn-outline btn-sm',
            onClick: () => showModal({
              title: '解除配对',
              message: '解除后需要重新配对才能管理设备',
              confirmText: '解除',
              danger: true,
              onConfirm: () => { unpair(); closeModal(); }
            })
          }, '\uD83D\uDD17 解除配对')
        )
      )
    )
  );
}

function renderAppList() {
  const search = S.searchText.toLowerCase();
  const filtered = search
    ? S.apps.filter(a => a.name.toLowerCase().includes(search) || a.packageName.toLowerCase().includes(search))
    : S.apps;
  const userApps = filtered.filter(a => !a.isSystem);
  const sysApps = filtered.filter(a => a.isSystem);
  const totalWhitelisted = S.apps.filter(a => a.isWhitelisted).length;
  const toUninstall = S.apps.length - totalWhitelisted;

  function toggleApp(pkg) {
    S.apps = S.apps.map(a => a.packageName === pkg && !a.isSystem ? { ...a, isWhitelisted: !a.isWhitelisted } : a);
  }
  function setAllUser(val) {
    S.apps = S.apps.map(a => a.isSystem ? a : { ...a, isWhitelisted: val });
  }

  function appRow(app) {
    return h('div', { className: 'app-row' },
      h('div', { className: 'app-info' },
        h('div', { className: 'app-name' }, app.name),
        h('div', { className: 'app-pkg' }, app.packageName)
      ),
      h('span', { className: 'app-size' }, app.size),
      h('label', { className: 'toggle' },
        h('input', {
          type: 'checkbox',
          checked: app.isWhitelisted,
          disabled: app.isSystem,
          onChange: () => toggleApp(app.packageName)
        }),
        h('span', { className: 'slider' })
      )
    );
  }

  return h('div', null,
    renderHeader('应用列表', () => { S.view = 'device'; S.searchText = ''; }),
    h('div', { className: 'container' },
      // Summary
      h('div', { className: 'summary-bar' },
        h('span', null, '\uD83D\uDCE6 ', `${S.apps.length} 总计`),
        h('span', { style: 'color:var(--success)' }, '\u2705 ', `${totalWhitelisted} 保留`),
        h('span', { style: 'color:var(--danger)' }, '\u274C ', `${toUninstall} 卸载`)
      ),

      // Search
      h('div', { className: 'search-bar' },
        h('input', {
          placeholder: '\uD83D\uDD0D 搜索应用名或包名...',
          value: S.searchText,
          onInput: (e) => { S.searchText = e.target.value; }
        })
      ),

      // User apps
      userApps.length ? h('div', { className: 'card' },
        h('div', { className: 'list-header' },
          h('span', { className: 'title' }, `用户应用 (${userApps.length})`),
          h('div', { className: 'actions-row' },
            h('span', { className: 'action-link', onClick: () => setAllUser(true) }, '全选'),
            h('span', { className: 'action-link', onClick: () => setAllUser(false) }, '全不选')
          )
        ),
        ...userApps.map(appRow)
      ) : null,

      // System apps
      sysApps.length ? h('div', { className: 'card' },
        h('div', { className: 'list-header' },
          h('span', { className: 'title' }, `系统应用 (${sysApps.length}) \u2014 强制保留`)
        ),
        ...sysApps.map(appRow)
      ) : null,

      // Save button
      h('button', {
        className: 'btn btn-primary',
        style: 'margin:16px 0 32px',
        onClick: () => showModal({
          title: '确认保存白名单',
          message: `将有 ${toUninstall} 个应用在卸载时被移除`,
          confirmText: '保存',
          danger: false,
          onConfirm: () => { sendWhitelist(); closeModal(); }
        })
      }, '\uD83D\uDCBE 保存白名单')
    )
  );
}

function renderModal() {
  if (!S.modal) return null;
  const m = S.modal;
  return h('div', { className: 'modal-mask', onClick: (e) => { if (e.target === e.currentTarget) closeModal(); } },
    h('div', { className: 'modal' },
      h('h3', null, m.title),
      h('p', null, m.message),
      h('div', { className: 'btn-group' },
        h('button', { className: 'btn btn-cancel', onClick: closeModal }, '取消'),
        h('button', { className: `btn ${m.danger ? 'btn-danger' : 'btn-primary'}`, onClick: m.onConfirm }, m.confirmText)
      )
    )
  );
}

function render() {
  const app = document.getElementById('app');
  app.innerHTML = '';

  let content;
  switch (S.view) {
    case 'pairing': content = renderPairing(); break;
    case 'device': content = renderDevice(); break;
    case 'applist': content = renderAppList(); break;
    default: content = h('div', { className: 'container', style: 'text-align:center;padding-top:40vh' },
      h('div', { className: 'spinner', style: 'border-color:var(--text2);border-top-color:var(--primary);width:32px;height:32px;margin:0 auto' }));
  }

  app.appendChild(content);

  const modal = renderModal();
  if (modal) app.appendChild(modal);

  if (S.toast) {
    app.appendChild(h('div', { className: 'toast' }, S.toast));
  }
}

// Init
function init() {
  mqttConnect();
  if (S.deviceId) {
    S.view = 'device';
  } else {
    S.view = 'pairing';
  }
  render();
}

init();
</script>
</body>
</html>
